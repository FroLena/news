import difflib
import re

# ÐšÑÑˆ Ð² Ð¿Ð°Ð¼ÑÑ‚Ð¸ (Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 50 Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ñ… Ñ‚ÐµÐºÑÑ‚Ð¾Ð²)
_raw_text_cache = []

# "Ð ÐÐ¡Ð¡Ð¢Ð Ð•Ð›Ð¬ÐÐ«Ð™ Ð¡ÐŸÐ˜Ð¡ÐžÐš" (Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ Ð²Ñ‹Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ)
# Ð•ÑÐ»Ð¸ Ð±Ð¾Ñ‚ ÑƒÐ²Ð¸Ð´Ð¸Ñ‚ ÑÑ‚Ð¾ Ð²Ð¾ Ð²Ñ…Ð¾Ð´ÑÑ‰ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚Ðµ â€” ÑÑ€Ð°Ð·Ñƒ Ð² Ð¼ÑƒÑÐ¾Ñ€ÐºÑƒ.
STOP_PATTERNS = [
    r"erid:",                # ÐœÐ°Ñ€ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° Ñ€ÐµÐºÐ»Ð°Ð¼Ñ‹
    r"2sub\.org",            # Ð¡ÑÑ‹Ð»ÐºÐ¸-Ð¿Ñ€Ð¾ÐºÐ»Ð°Ð´ÐºÐ¸
    r"t\.me/\+",             # Ð¡ÑÑ‹Ð»ÐºÐ¸ Ð½Ð° Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ ÐºÐ°Ð½Ð°Ð»Ñ‹
    r"#Ñ€ÐµÐºÐ»Ð°Ð¼Ð°",             # Ð¥ÐµÑˆÑ‚ÐµÐ³ Ñ€ÐµÐºÐ»Ð°Ð¼Ñ‹
    r"Ñ€ÐµÐºÐ»Ð°Ð¼Ð°\.",            # Ð¡Ð»Ð¾Ð²Ð¾ Ñ€ÐµÐºÐ»Ð°Ð¼Ð°
    r"Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð´Ð°Ð»ÑŒÑˆÐµ",        # ÐšÐ»Ð¸ÐºÐ±ÐµÐ¹Ñ‚
    r"Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ðµ",
    r"Ð² ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÑÑ…ðŸ‘‡",
    r"Ð·Ð°Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð½Ð°",      # Ð¡ÐºÐ°Ð¼/ÐšÑ€Ð¸Ð¿Ñ‚Ð°
    r"ÑÑ‚Ð°Ð²ÐºÐ¸ Ð½Ð° ÑÐ¿Ð¾Ñ€Ñ‚",      # Ð‘ÐµÑ‚Ñ‚Ð¸Ð½Ð³
    r"Ð´Ð¾Ð±Ñ€Ð¾Ðµ ÑƒÑ‚Ñ€Ð¾",          # ÐœÑƒÑÐ¾Ñ€
    r"ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾Ð¹ Ð½Ð¾Ñ‡Ð¸",       # ÐœÑƒÑÐ¾Ñ€
]

def check_stop_words(text):
    """
    ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ñ‚ÐµÐºÑÑ‚ Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÑÑ‚Ð¾Ð¿-ÑÐ»Ð¾Ð².
    True = ÐÐ°Ð¹Ð´ÐµÐ½Ð° Ñ€ÐµÐºÐ»Ð°Ð¼Ð°/Ð¼ÑƒÑÐ¾Ñ€.
    """
    text_lower = text.lower()
    for pattern in STOP_PATTERNS:
        if re.search(pattern, text_lower):
            return True
    return False

def is_duplicate(text):
    """
    ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ñ‚ÐµÐºÑÑ‚ Ð½Ð° ÑÑ…Ð¾Ð¶ÐµÑÑ‚ÑŒ Ñ ÐºÑÑˆÐµÐ¼ (Fuzzy Match).
    """
    global _raw_text_cache
    
    # 1. Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ
    for old_text in _raw_text_cache:
        matcher = difflib.SequenceMatcher(None, text, old_text)
        if matcher.ratio() > 0.65: # 65% ÑÑ…Ð¾Ð´ÑÑ‚Ð²Ð°
            return True
            
    # 2. ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÑÑˆÐ°
    _raw_text_cache.append(text)
    if len(_raw_text_cache) > 50:
        _raw_text_cache.pop(0)
        
    return False
